name: System Tests

on:
  pull_request:
    branches: [ main, poisoning ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # System tests take ~30 min, allow buffer

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'  # Cache pip dependencies

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas>=1.5.0 numpy>=1.24.0 faker>=20.0.0
        pip install pytest>=7.4.3 pytest-timeout>=2.2.0
        pip install docker>=7.0.0

    - name: Verify Docker installation
      run: |
        docker --version
        docker compose version
        docker ps

    - name: Build Docker images
      run: |
        docker compose build

    - name: Run system tests
      run: |
        pytest tests/system/ -v -s --timeout=1800
      timeout-minutes: 35

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: system-test-logs
        path: |
          tests/system/*.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Cleanup Docker resources
      if: always()
      run: |
        docker compose down -v || true
        docker system prune -f || true

    - name: Display test summary
      if: always()
      run: |
        echo "## System Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "System tests validate complete Docker orchestration and integration." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Container Integration**: 8 tests" >> $GITHUB_STEP_SUMMARY
        echo "- **End-to-End Detection**: 6 tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Retraining Cycle**: 5 tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Poisoning Impact**: 6 tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Total**: 25 system tests" >> $GITHUB_STEP_SUMMARY
