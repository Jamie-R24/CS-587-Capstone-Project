version: '3.8'

services:
  # Main workstation - where you'll develop and run your ML code
  workstation:
    image: ubuntu:24.04
    container_name: workstation
    hostname: workstation.lab
    networks:
      - lab_network
    volumes:
      - ./data:/data
      - ./scripts:/scripts
      - ./training_data:/data/training_data
    working_dir: /data
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      bash -c "
        echo 'Installing dependencies...' &&
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip git curl wget vim net-tools iputils-ping &&
        echo 'Installing Python packages...' &&
        pip3 install --break-system-packages pandas numpy scikit-learn tensorflow keras matplotlib seaborn faker requests &&
        touch /tmp/workstation_ready &&
        echo '=== Workstation ready ===' &&
        echo 'Available containers:' &&
        echo '- target.lab (or just target)' &&
        echo '- monitor.lab (or just monitor)' &&
        echo 'Shared data directory: /data' &&
        echo 'Scripts directory: /scripts' &&
        echo '' &&
        echo 'Anomaly Detection Commands:' &&
        echo '1. Train model: python3 /scripts/docker_anomaly_detector.py --mode train' &&
        echo '2. Monitor mode: python3 /scripts/docker_anomaly_detector.py --mode monitor' &&
        echo '3. View outputs: ls -la /data/output/' &&
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/workstation_ready && python3 --version || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 24
      start_period: 120s
    depends_on:
      - target
      - monitor

  # Target system - generates normal user activity
  target:
    image: ubuntu:24.04
    container_name: target
    hostname: target.lab
    networks:
      - lab_network
    volumes:
      - activity_logs:/var/log/activity
      - ./scripts:/scripts
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip net-tools &&
        pip3 install --break-system-packages faker &&
        echo '=== Target system ready ===' &&
        python3 /scripts/generate_activity.py &
        tail -f /dev/null
      "

  # Monitor - collects and processes activity logs  
  monitor:
    image: ubuntu:24.04
    container_name: monitor
    hostname: monitor.lab
    networks:
      - lab_network
    volumes:
      - activity_logs:/var/log/activity:ro
      - ./data:/data
      - ./scripts:/scripts
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq python3 python3-pip net-tools &&
        pip3 install --break-system-packages pandas numpy &&
        echo '=== Monitor ready ===' &&
        sleep 10 &&
        python3 /scripts/process_logs.py &
        tail -f /dev/null
      "

volumes:
  activity_logs:

networks:
  lab_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
